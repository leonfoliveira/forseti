name: judge-e2e
services:

  postgres:
    container_name: e2e-judge-postgres
    image: postgres:17.5-alpine
    environment:
      POSTGRES_USER: judge
      POSTGRES_PASSWORD: judge
      POSTGRES_DB: judge
    ports:
      - "5432:5432"
    networks:
      - e2e-judge-network

  localstack:
    container_name: e2e-judge-localstack
    image: gresau/localstack-persist:4.4.0
    environment:
      SERVICES: s3,sqs
    ports:
      - "4566:4566"
    volumes:
      - ./localstack-bootstrap:/etc/localstack/init/ready.d
    networks:
      - e2e-judge-network
  
  api:
    depends_on:
      - localstack
      - migration
    environment:
      ALLOWED_ORIGINS: http://localhost:80
      AWS_ACCESS_KEY_ID: judge
      AWS_ENDPOINT: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_S3_BUCKET: judge
      AWS_SECRET_ACCESS_KEY: judge
      AWS_SQS_SUBMISSION_FAILED_QUEUE: submission-failed-queue
      AWS_SQS_SUBMISSION_QUEUE: submission-queue
      DB_PASSWORD: judge
      DB_URL: jdbc:postgresql://postgres:5432/judge
      DB_USER: judge
      JAVA_TOOL_OPTIONS: -Xms1024m -Xmx1024m
      JWT_EXPIRATION: 6h
      JWT_ROOT_EXPIRATION: 3h
      JWT_SECRET: judge
      PORT: 8080
      ROOT_PASSWORD: judge
      SPRING_PROFILES_ACTIVE: production
    image: judge-api:latest
    networks:
      - e2e-judge-network
    ports:
      - "8080:8080"    
  
  autojudge:
    depends_on:
      - api
    environment:
      API_URL: http://api:8080
      AWS_ACCESS_KEY_ID: judge
      AWS_ENDPOINT: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_S3_BUCKET: judge
      AWS_SECRET_ACCESS_KEY: judge
      AWS_SQS_SUBMISSION_QUEUE: submission-queue
      DB_PASSWORD: judge
      DB_URL: jdbc:postgresql://postgres:5432/judge
      DB_USER: judge
      JAVA_TOOL_OPTIONS: -Xms1536M -Xmx1536M
      JWT_EXPIRATION: 6h
      JWT_ROOT_EXPIRATION: 3h
      JWT_SECRET: judge
      MAX_CONCURRENT_SUBMISSIONS: "1"
      PORT: 8081
      ROOT_PASSWORD: judge
      SPRING_PROFILES_ACTIVE: production
    image: judge-autojudge:latest
    networks:
      - e2e-judge-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
  
  migration:
    depends_on:
      - postgres
    entrypoint: sh -c "flyway -url=$${FLYWAY_URL} -user=$${FLYWAY_USER} -password=$${FLYWAY_PASSWORD} -connectRetries=60 migrate"
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/judge
      FLYWAY_USER: judge
      FLYWAY_PASSWORD: judge
    image: flyway/flyway:11.9.2-alpine
    networks:
      - e2e-judge-network
    volumes:
      - ../../judge-backend/common/src/main/resources/migration:/flyway/sql
  
  webapp:
    depends_on:
      - api
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '1.0'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8080
      NEXT_PUBLIC_LOCALE: en
      NEXT_PUBLIC_VERSION: latest
      NODE_ENV: production
    image: judge-webapp:latest
    networks:
      - e2e-judge-network
    ports:
      - "80:80"

networks:
  e2e-judge-network:
    driver: bridge
