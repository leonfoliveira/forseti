meta {
  name: update_contest
  type: http
  seq: 5
}

put {
  url: {{base_url}}
  body: json
  auth: inherit
}

headers {
  x-csrf-token: {{csrf_token}}
}

body:json {
  {
    "id": "{{contest_id}}",
    "slug": "{{$randomWord}}",
    "title": "{{$randomWords}}",
    "languages": [
      "{{Submission.Language.CPP_17}}",
      "{{Submission.Language.JAVA_21}}",
      "{{Submission.Language.PYTHON_312}}"
    ],
    "startAt": "2026-01-01T00:00:00Z",
    "endAt": "2026-01-02T00:00:00Z",
    "settings": {
      "isAutoJudgeEnabled": true
    },
    "members": [
      {
        "type": "{{Member.Type.CONTESTANT}}",
        "name": "{{$randomFirstName}}",
        "login": "contestant",
        "password": "123"
      },
      {
        "type": "{{Member.Type.JUDGE}}",
        "name": "{{$randomFirstName}}",
        "login": "judge",
        "password": "123"
      },
      {
        "type": "{{Member.Type.ADMIN}}",
        "name": "{{$randomFirstName}}",
        "login": "admin",
        "password": "123"
      }
    ],
    "problems": [
      {
        "letter": "A",
        "title": "{{$randomWords}}",
        "description": {
          "id": "{{description_attachment_id}}"
        },
        "timeLimit": 1000,
        "memoryLimit": 1024,
        "testCases": {
          "id": "{{test_cases_attachment_id}}"
        }
      }
    ]
  }
}

vars:pre-request {
  description_attachment_id: 123
  test_cases_attachment_id: 123
}

script:pre-request {
  async function uploadFile(file, context) {  
    bru.setVar("file", file)  
    bru.setVar("context", context)
    const response = await bru.runRequest("contests/attachment/upload_attachment")
    console.log(response)
    return response.data
  }
  
  const descriptionAttachment = await uploadFile("description.pdf", "PROBLEM_DESCRIPTION")
  const testCasesAttachment = await uploadFile("test_cases.csv", "PROBLEM_TEST_CASES")
  
  bru.setVar("description_attachment_id", descriptionAttachment.id)
  bru.setVar("test_cases_attachment_id", testCasesAttachment.id)
}

script:post-response {
  const problemId = res.body.problems[0].id
  
  bru.setVar("problem_id", problemId)
}

settings {
  encodeUrl: true
  timeout: 0
}
